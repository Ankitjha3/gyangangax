rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check auth
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper to check college
    function isGyanGanga() {
       return request.resource.data.college == "Gyan Ganga Group of Institutions" || 
              resource.data.college == "Gyan Ganga Group of Institutions";
    }

    // Users: Users can read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow write if it's the user themselves OR if it's just a followerCount update
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followerCount']));
      allow delete: if isAuthenticated() && request.auth.uid == userId;

      // Subcollections for social graph
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (request.auth.uid == followerId || request.auth.uid == userId);
      }
      
      match /following/{followingId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated() && (request.auth.uid == userId);
      }

      // Notifications: 
      // - Create: Any auth user (to send notif)
      // - Read: Only owner
      // - Update: Only owner (mark read)
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Posts, Assignments, Roommates, Confessions
    // Allow read/write for all authenticated users
    // In a real app, strict validation on schema would be here
    
    match /posts/{postId} {
      allow read, write: if isAuthenticated();
      
      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
      
      match /likes/{uid} {
         allow read, write: if isAuthenticated();
      }
    }
    
    match /assignments/{assignmentId} {
      allow read, write: if isAuthenticated();
      
      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    match /roommate_posts/{postId} {
      allow read, write: if isAuthenticated();

      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    match /confessions/{postId} {
      allow read, write: if isAuthenticated();

      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }

    // Messaging Rules: Strict
    // Only participants can read/write
    // Messaging Rules: Strict
    // Only participants can read/write
    match /chats/{chatId} {
      // Allow read if user is participant OR if we are checking for existence (resource == null)
      allow read: if isAuthenticated(); 
      // Allow write if user is participant 
      allow write: if isAuthenticated() && (resource == null || request.auth.uid in resource.data.participants);
      
      allow create: if isAuthenticated();

      match /messages/{messageId} {
         allow read, write: if isAuthenticated(); 
      }
    }

    // Payments Rules (Fixed: Admin Dashboard Access)
    match /payments/{paymentId} {
      allow read, write: if isAuthenticated();
    }
  }
}
