rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check auth
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper to check admin
    function isAdmin() {
      return request.auth.token.email == "ajha10597@gmail.com";
    }

    // Helper to check college
    function isGyanGanga() {
       return request.resource.data.college == "Gyan Ganga Group of Institutions" || 
              resource.data.college == "Gyan Ganga Group of Institutions";
    }

    // Users: Users can read/write their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow write if it's the user themselves OR if it's just a followerCount update
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followerCount', 'isVerified', 'isSuspended'])
      );
      allow delete: if isAuthenticated() && request.auth.uid == userId;

      // Subcollections for social graph
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        // Allow write if you are the follower (creating the follow) OR the user (removing the follower?)
        // Actually, usually follower writes to their own ID in followers subcol
        allow write: if isAuthenticated(); 
      }
      
      match /following/{followingId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
      }

      // Notifications: 
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow create: if isAuthenticated(); // Anyone can send notif
        allow update, delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // Posts, Assignments, Roommates, Confessions
    match /posts/{postId} {
      allow read, write: if isAuthenticated();
      
      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
      
      match /likes/{uid} {
         allow read, write: if isAuthenticated();
      }
    }
    
    match /assignments/{assignmentId} {
      allow read, write: if isAuthenticated();
      
      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    match /roommate_posts/{postId} {
      allow read, write: if isAuthenticated();

      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    match /confessions/{postId} {
      allow read, write: if isAuthenticated();

      match /comments/{commentId} {
        allow read, write: if isAuthenticated();
      }
    }

    match /study_links/{linkId} {
      allow get: if true;
      allow list: if isAuthenticated();
      allow create: if isAuthenticated();
      // Admin OR Owner can delete/full update. Others can ONLY update commentCount.
      allow delete: if isAuthenticated() && (isAdmin() || request.auth.uid == resource.data.authorId);
      allow update: if isAuthenticated() && (
        isAdmin() || 
        request.auth.uid == resource.data.authorId ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']))
      );
      
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        // Allow delete if author or Admin
        allow delete: if isAuthenticated() && (isAdmin() || request.auth.uid == resource.data.authorId);
      }
    }

    match /marketplace_items/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Admin OR Owner can update/delete
      allow update, delete: if isAuthenticated() && (isAdmin() || request.auth.uid == resource.data.sellerId);
    }

    // Messaging Rules: Strict
    // Only participants can read/write
    // Messaging Rules: Strict
    // Only participants can read/write
    match /chats/{chatId} {
      // Allow read if user is participant OR if we are checking for existence (resource == null)
      allow read: if isAuthenticated(); 
      // Allow write if user is participant 
      allow write: if isAuthenticated() && (resource == null || request.auth.uid in resource.data.participants);
      
      allow create: if isAuthenticated();

      match /messages/{messageId} {
         allow read, write: if isAuthenticated(); 
      }
    }

    // Payments Rules (Fixed: Admin Dashboard Access)
    match /payments/{paymentId} {
      allow read, write: if isAuthenticated();
    }
  }
}
